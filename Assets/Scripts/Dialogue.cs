using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.UI;

public class Dialogue : MonoBehaviour
{
    //public string character = "????";
    //private string message = "???? ?????? ?????? ?????? ???? ???? ?????? ?? ?????? \n - Good Ending- ";

    public Text EndingText;
    public int EndingIdx;
    private string[] texts;
    private int clickCount;
    private int clickCount2 = 0;
    public GameManager gameManager;
    public GameObject[] Endings;
    public GameObject DialogPanel;

    public PlayerMove playerMove;
    public GameObject playerObject;
    // Start is called before the first frame update

    void Start()
    {
        playerObject = GameObject.FindWithTag("Player");

        if (playerObject != null)
        {
            playerMove = playerObject.GetComponent<PlayerMove>();
        }
        clickCount = 0;

        if (playerMove.bossDie) //boss???????????? ????
            PlayEnding();

    }
    private void PlayEnding()
    {

        if (gameManager.totalKey < 30)
           EndingIdx = 2;
        else if (gameManager.totalKey <50)
           EndingIdx = 1;
        else
            EndingIdx = 0;

        Endings[EndingIdx].SetActive(true);



        if (EndingIdx == 0)
        {
            texts = new string[5];
            texts[0] = "은이는 세상의 모든 보물을 모아 부자가 되었다.";
            texts[1] = "그래서 오랫동안 꿈꿔왔던 궁전을 세워 공주 놀이를 하였다.";
            texts[2] = "그러나 은이는 또 다른 보물이 생기길 기다리고 있는 중이다 트레저 헌터의 열정은 아직 사라지지 않았나보다.";
            texts[3] = "또 다른 보물이 나타나면 ... 아마 은이 또 긴 여정을 떠날 것이다.....\n (그러면 은이야 보물 나 조금만 나눠주고 가 )";

            texts[4] = "- Good Ending -";
        }

        if (EndingIdx == 1)
        {
            texts = new string[6];
            texts[0] = "은이는 세상의 모든 보물을 다 모으지는 못했지만 이 정도로 만족하기로한다..";
            texts[1] = "은이는 보물사냥꾼으로써의 삶을 끝내고, 농부로써의 두번째 삶을 시작했다.";
            texts[2] = "몬스터와 싸우고 보물을 얻을 때 만큼의 스릴은 없지만, 은이는 노동의 가치와 수확의 기쁨을 알게 되었다.";
            texts[3] = "은이는 매일 열심히 밀과 체리, 사과를 키우고 수확한다.";

            texts[4] = "은이는 농부로써의 두번째 삶에 만족한다\n" +
                "은이의 집에 놀러가면, 보물보다 귀한 농산물을 얻을 수 있을지도....";

            texts[5] = "- Normal Ending -";
        }

        if (EndingIdx == 2)
        {
            texts = new string[10];
            texts[0] = "?????? ?????? ?????? ???? ??????.";
            texts[1] = "???? ?????? ?????? ???? ???? ???? ?????? ???? ????????..";

            texts[2] = "???????? ???? ????????????, ?????? ?????? ???? ???? ??????.";
            texts[3] = "?????? ???? ?????? ???? ?? ????,\n ???????? ?????????????? ????.";
            texts[4] = "?????? ???????? ???????? ?????? ???? ??????????.";
            texts[5] = "???? ???????? ???? ???? ?????????? ???????? ?????? ?????? ???? ???? ??????????????.";
            texts[6] = "?????? ???? ?????? ?????? ?????????";
            texts[7] = "???? ?????? ???????? ???? ??????????????...!!";

            texts[8] = "????????.... ?????? ?? ?? ???? ?????? ?? ??????.";
            texts[9] = "- Bad Ending -";
        }

        StartCoroutine(Typing(texts[clickCount]));
        clickCount++;

        clickCount2=1; //clickCount2=1 : ?????? clickCount2=2: doubleclicked clickCount2=0: default
    }

    public void SecretRoom()
    {
        //Debug.Log("dia ????");
        DialogPanel.SetActive(true);

        texts = new string[1];
        texts[0] = "?????? ???? ?????????? ?????? ???? ?????? ?? ????... " +
            "\n?????? ?? ?????? ???? ??????????.";

        if(clickCount2==0)
            StartCoroutine(Typing(texts[0]));
        clickCount2 = 1;
        clickCount++;
        //DialogPanel.SetActive(false);
    }

    // Update is called once per frame
    void Update()
    {
        //Debug.Log(texts.Length);
        if (Input.GetMouseButtonDown(0) && clickCount < texts.Length)
        {
            if (clickCount2 == 0)
            {
                StartCoroutine(Typing(texts[clickCount]));
                clickCount++;
                clickCount2=1;
            }
            else
            {
                clickCount2=2;
            }

        }else if(Input.GetMouseButtonDown(0))
        {
            if (playerMove.bossDie)
                gameManager.clear();
            else
            {
                if (clickCount == 1)
                {
                    clickCount2 = 2;
                    clickCount++;
                }
                else
                {
                    clickCount = 0;
                    DialogPanel.SetActive(false);
                }
                    
            }
        }
    }

    IEnumerator Typing(string message)
    {
        for (int i = 0; i < message.Length; i++)
        {
            if (clickCount2==2)
            {
                EndingText.text = message;
                if (i == message.Length - 1)
                {
                    clickCount2 = 0;
                    //Debug.Log("clickCount2==1");
                }
                yield return null;
            }
            else
            {
                EndingText.text = message.Substring(0, i + 1);
                if (i == message.Length - 1)
                {
                    clickCount2 = 0;
                }
                yield return new WaitForSeconds(0.1f);
            }
        }


    }

}
